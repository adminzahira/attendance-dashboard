<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Attendance Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:10px;
}
h1{
  text-align:center;
  font-size:22px;
}
.controls{
  text-align:center;
  margin-bottom:10px;
}
select{
  padding:10px;
  font-size:16px;
  width:100%;
  max-width:300px;
}
.table-wrap{
  overflow-x:auto;
}
table{
  width:100%;
  min-width:520px;
  border-collapse:collapse;
}
th,td{
  border:1px solid #333;
  padding:6px;
  text-align:center;
  font-size:14px;
}
th{
  background:#222;
  color:#fff;
}
.total-row{
  background:#ddd;
  font-weight:bold;
}
.missing{
  background:#ffcccc;
  color:#900;
  font-weight:bold;
}
.note{
  text-align:center;
  font-size:13px;
  margin:8px;
  color:#555;
}
canvas{
  max-width:100%;
}
</style>
</head>

<body>

<h1>ðŸ“‹ Daily Attendance Dashboard</h1>

<div class="controls">
  <select id="dateSelect"></select>
</div>

<div class="note">ðŸ”„ Auto updates every 60 seconds</div>

<div id="tables"></div>

<canvas id="chart"></canvas>

<script>
const SHEET_CSV =
"https://docs.google.com/spreadsheets/d/1Xl26B96aKzcZT9SnrhR5H9CNjVt9uAEYPm8fjJAr0m4/export?format=csv&gid=780160508";

let chart;

function parseCSV(text){
  return text.trim().split("\n").map(r =>
    r.split(",").map(c => c.replace(/^"|"$/g,""))
  );
}

async function loadData(){
  const res = await fetch(SHEET_CSV);
  const text = await res.text();
  const rows = parseCSV(text);
  const headers = rows.shift();

  const data = {};
  rows.forEach(r=>{
    const obj = {};
    headers.forEach((h,i)=>obj[h]=r[i]);
    const d = obj["Date"];
    const cls = obj["Grade"];
    if(!data[d]) data[d]={};
    data[d][cls]=obj; // latest overwrite
  });

  buildUI(data);
}

function buildUI(data){
  const dates = Object.keys(data).sort().reverse();
  const select = document.getElementById("dateSelect");
  select.innerHTML="";
  dates.forEach(d=>{
    const o=document.createElement("option");
    o.value=d;o.text=d;
    select.appendChild(o);
  });
  select.onchange=()=>renderDate(data,select.value);
  renderDate(data,dates[0]);
}

function renderDate(data,date){
  const classes = Object.keys(data[date]).sort((a,b)=>{
    const g1=parseInt(a), g2=parseInt(b);
    return g1===g2 ? a.localeCompare(b) : g1-g2;
  });

  let html=`<div class="table-wrap"><table>
  <tr><th>Grade</th><th>Boys</th><th>Girls</th><th>Total</th></tr>`;

  let tb=0,tg=0,tt=0;
  const labels=[], totals=[];

  classes.forEach(c=>{
    const r=data[date][c];
    const b=+r["No of Boys"]||0;
    const g=+r["No of Girls"]||0;
    const t=b+g;
    tb+=b;tg+=g;tt+=t;
    labels.push(c);totals.push(t);
    html+=`<tr>
      <td>${c}</td>
      <td>${b||"<span class='missing'>X</span>"}</td>
      <td>${g||"<span class='missing'>X</span>"}</td>
      <td>${t||"<span class='missing'>X</span>"}</td>
    </tr>`;
  });

  html+=`<tr class="total-row">
    <td>Total</td><td>${tb}</td><td>${tg}</td><td>${tt}</td>
  </tr></table></div>`;

  document.getElementById("tables").innerHTML=html;

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{labels,datasets:[{label:"Total Students",data:totals}]},
    options:{responsive:true}
  });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
